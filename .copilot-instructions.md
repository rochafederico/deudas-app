# Copilot Instructions - Deudas App

## Arquitectura del Proyecto

Este es un **Control de Deudas** construido con JavaScript vanilla, Web Components e IndexedDB.

### Stack Tecnológico
- **Frontend**: HTML5, CSS3, JavaScript ES6+ (sin frameworks)
- **Web Components**: UI modular con Shadow DOM
- **Base de datos**: IndexedDB para persistencia local
- **Arquitectura**: SPA (Single Page Application) con routing básico

### Estructura de Carpetas
```
src/
├── components/          # Web Components UI reutilizables
├── models/             # Modelos de datos (DeudaModel, MontoModel)
├── entity/             # Entidades para IndexedDB
├── repository/         # Capa de acceso a datos (CRUD)
├── database/           # Inicialización y esquema de DB
├── utils/              # Utilidades (DOM, formateo)
├── pages/              # Componentes de página principal
└── config/             # Configuraciones (columnas, opciones)
```

## Modelos de Datos

### Deuda
```javascript
{
  id: number,
  acreedor: string,
  tipoDeuda: string,
  notas: string,
  montos: Monto[]
}
```

### Monto
```javascript
{
  id: number,
  deudaId: number,
  monto: number,
  moneda: string,
  vencimiento: string, // YYYY-MM-DD
  periodo: string,     // YYYY-MM
  pagado: boolean
}
```

## Patrones y Convenciones

### Web Components
- Usar Shadow DOM para encapsulación
- Eventos personalizados para comunicación entre componentes
- Ejemplo: `this.dispatchEvent(new CustomEvent('deuda:saved', { bubbles: true }))`
- `observedAttributes` para propiedades reactivas

### Nomenclatura
- **Componentes**: PascalCase (`DebtForm`, `AppButton`)
- **Archivos**: camelCase (`deudaRepository.js`, `montoRepository.js`)
- **Eventos**: kebab-case (`deuda:saved`, `month-change`)
- **CSS**: kebab-case con prefijos (`--accent-color`, `.debt-list`)

### Gestión de Estado
- `EventBus` global para comunicación entre componentes
- Estado local en cada componente
- Persistencia automática en IndexedDB
- No usar estado global centralizado

## Componentes Principales

### AppShell
- Contenedor principal de la aplicación
- Maneja routing básico y estado global del mes actual

### DebtList 
- Lista principal de deudas con filtros
- Agrupamiento dinámico (acreedor, tipo, moneda, vencimiento)
- Navegación por mes con totales

### DebtForm
- Formulario CRUD para deudas y montos
- Validación integrada
- Manejo de múltiples montos por deuda

### AppTable
- Tabla reutilizable con columnas configurables
- Ordenamiento y formateo automático
- Integrada con sistema de agrupamiento

## Repositorios

### deudaRepository
```javascript
// CRUD básico
await addDeuda(deuda)
await getDeuda(id)
await updateDeuda(deuda)
await deleteDeuda(id)
await listDeudas()
```

### montoRepository
```javascript
// CRUD con filtros
await addMonto(monto)
await listMontos(periodo) // periodo: "YYYY-MM"
await updateMonto(monto)
await deleteMonto(id)
```

## Utilidades Importantes

### Formateo
```javascript
// utils.js
fmtMoneda(amount, currency) // Formateo con Intl
fmtFecha(date) // Formato DD/MM/YYYY

// utils/dom.js
el(tag, props, children) // Helper para crear elementos
getFormValuesAndValidate(form) // Validación de formularios
```

### IndexedDB
- **Stores**: `deudas`, `montos`
- **Índices**: `by_deudaId`, `by_periodo`
- Usar transacciones para operaciones complejas
- Auto-inicialización con datos demo

## Estilos

### Variables CSS (base.css)
```css
--primary-color: #007bff
--accent-color: #28a745
--danger-color: #dc3545
--dark-bg: #1a1a1a
```

### Modo Oscuro
- Clase `dark-mode` en body
- Variables CSS para theming automático
- Componente `DarkToggle` para alternar

## Flujos de Trabajo Típicos

### Agregar Nueva Deuda
1. Usuario click en "Agregar" → `HeaderBar`
2. Abrir modal → `DebtModal`
3. Completar formulario → `DebtForm`
4. Guardar en DB → `deudaRepository.addDeuda()`
5. Disparar evento → `deuda:saved`
6. Actualizar lista → `DebtList.loadDebts()`

### Filtrar por Mes
1. Usuario selecciona mes → `HeaderBar`
2. Disparar evento → `month-change`
3. Actualizar datos → `DebtList.loadDebts(periodo)`
4. Consultar montos → `montoRepository.listMontos(periodo)`

## Funcionalidades Específicas

- **Duplicar Montos**: Crear copias de montos existentes para nuevos períodos
- **Exportar Datos**: JSON completo de deudas y montos
- **Agrupamiento Dinámico**: Por acreedor, tipo, moneda, vencimiento
- **Validación**: Formularios con mensajes de error personalizados
- **Navegación por Mes**: Con totales automáticos por período

## Convenciones de Código

### Eventos Personalizados
```javascript
// Siempre usar bubbles: true para propagación
this.dispatchEvent(new CustomEvent('evento:nombre', {
  detail: { data },
  bubbles: true
}))
```

### Manejo de Errores
```javascript
try {
  await repository.action()
} catch (error) {
  console.error('Error en acción:', error)
  // Mostrar mensaje al usuario
}
```

### Componentes Web
```javascript
class MiComponente extends HTMLElement {
  static observedAttributes = ['prop']
  
  connectedCallback() {
    this.attachShadow({ mode: 'open' })
    this.render()
  }
  
  attributeChangedCallback() {
    this.render()
  }
}
```

## Buenas Prácticas

- Siempre usar Shadow DOM para componentes
- Validar datos antes de guardar en IndexedDB  
- Usar eventos personalizados para comunicación
- Mantener componentes pequeños y enfocados
- Formatear monedas con Intl para internacionalización
- Usar transacciones IndexedDB para operaciones relacionadas
- Aplicar loading states durante operaciones async